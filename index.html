<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <meta name="description" content="GhostDrop Social - P2P Secure File Transfer">
    
    <!-- PWA Manifest (Embedded) -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"GhostDrop","short_name":"GhostDrop","start_url":".","display":"standalone","background_color":"#ffffff","theme_color":"#ffffff","icons":[{"src":"https://api.dicebear.com/7.x/shapes/svg?seed=ghost","sizes":"192x192","type":"image/svg+xml"}]}'>
    <link rel="apple-touch-icon" href="https://api.dicebear.com/7.x/shapes/png?seed=ghost">

    <title>GhostDrop Social v2.0</title>

    <!-- Dependencies -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root {
            --bg: #ffffff; --fg: #000000; --border: #000000;
            --dim: #666666; --light: #f4f4f4; --accent: #000000;
            --font-mono: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, monospace;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            background: var(--bg); color: var(--fg);
            font-family: var(--font-mono); font-size: 13px;
            height: 100dvh; overflow: hidden;
            display: flex; flex-direction: column;
            user-select: none;
        }

        /* LAYOUT */
        #app {
            display: grid;
            grid-template-rows: 50px 1fr;
            grid-template-columns: 280px 1fr;
            height: 100%; width: 100%;
        }

        /* TOP BAR */
        #top-bar {
            grid-column: 1 / -1; grid-row: 1;
            border-bottom: 2px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; background: var(--bg); z-index: 20;
        }

        /* SIDEBAR */
        #sidebar {
            grid-column: 1; grid-row: 2;
            border-right: 2px solid var(--border);
            display: flex; flex-direction: column;
            background: var(--light); overflow: hidden;
        }

        /* MAIN PANEL */
        #main-panel {
            grid-column: 2; grid-row: 2;
            display: flex; flex-direction: column;
            background: var(--bg); position: relative;
            overflow-y: auto; overflow-x: hidden;
        }

        /* MOBILE */
        @media (max-width: 768px) {
            #app { display: flex; flex-direction: column; }
            #sidebar { display: none; flex: 1; border-right: none; }
            #main-panel { display: none; flex: 1; }
            #sidebar.active, #main-panel.active { display: flex; }
            .mobile-nav { display: flex !important; }
        }

        /* UI ELEMENTS */
        .btn {
            background: var(--fg); color: var(--bg);
            border: 2px solid var(--fg); padding: 8px 16px;
            font-family: inherit; font-weight: bold;
            cursor: pointer; text-transform: uppercase;
            display: inline-flex; justify-content: center; align-items: center; gap: 6px;
            transition: all 0.1s;
        }
        .btn:active { transform: translateY(1px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-outline { background: transparent; color: var(--fg); }
        .btn-danger { background: #fff; color: #d00; border-color: #d00; }
        .btn-icon { padding: 8px; min-width: 0; }
        .btn-small { padding: 4px 8px; font-size: 11px; }

        .input {
            border: 2px solid var(--border); padding: 10px;
            font-family: inherit; width: 100%; background: #fff; outline: none;
        }
        .input:focus { border-color: #000; background: #fff; }

        /* TABS */
        .tab-bar { display: flex; border-bottom: 2px solid var(--border); background: var(--bg); }
        .tab-item { 
            flex: 1; text-align: center; padding: 12px; cursor: pointer; 
            font-weight: bold; background: var(--light); border-bottom: 3px solid transparent;
        }
        .tab-item.active { background: var(--bg); border-bottom-color: var(--fg); }

        /* LISTS */
        .list-item {
            padding: 12px 16px; border-bottom: 1px solid #ddd;
            cursor: pointer; display: flex; align-items: center; justify-content: space-between;
            position: relative;
        }
        .list-item:hover { background: #fff; }
        .list-item.active { background: var(--fg); color: var(--bg); }
        
        .signal-bars {
            display: flex; align-items: flex-end; gap: 2px; height: 12px;
        }
        .bar { width: 3px; background: #ccc; }
        .bar.on { background: currentColor; }

        /* STATE VIEWS */
        .state-view { 
            padding: 24px; max-width: 600px; margin: 0 auto; width: 100%; text-align: center; 
        }
        .hidden { display: none !important; }

        .stat-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
            margin: 20px 0; text-align: left; border: 2px solid var(--border); padding: 16px;
        }
        .stat-label { color: var(--dim); font-size: 10px; text-transform: uppercase; }
        .stat-val { font-size: 14px; font-weight: bold; }

        .progress-wrap {
            border: 2px solid var(--border); height: 24px; position: relative; margin: 20px 0;
        }
        .progress-fill {
            height: 100%; background: var(--fg); width: 0%; transition: width 0.2s;
        }

        /* CONTEXT MENU */
        #context-menu {
            position: fixed; background: #fff; border: 2px solid #000;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.2); z-index: 1000;
            display: none; flex-direction: column; min-width: 150px;
        }
        .ctx-item { padding: 12px; cursor: pointer; text-align: left; font-weight: bold; }
        .ctx-item:hover { background: #eee; }
        .ctx-item.danger { color: #d00; }

        /* SETTINGS & MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95); z-index: 2000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: #fff; border: 2px solid #000; padding: 24px;
            width: 90%; max-width: 400px; box-shadow: 8px 8px 0 rgba(0,0,0,0.1);
        }

        /* TOAST */
        #toast-container { position: fixed; bottom: 70px; right: 20px; z-index: 3000; }
        .toast {
            background: #000; color: #fff; padding: 12px 20px; margin-top: 10px;
            border: 1px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            animation: slideIn 0.3s; display: flex; justify-content: space-between; gap: 10px;
        }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* MOBILE NAV */
        .mobile-nav {
            display: none; height: 60px; border-top: 2px solid var(--border);
            background: var(--bg); flex-shrink: 0; z-index: 50;
        }
        .nav-btn { flex: 1; border: none; background: transparent; font-weight: bold; }
        .nav-btn.active { background: #eee; border-top: 3px solid #000; }

    </style>
</head>
<body>

<div id="app">
    <!-- TOP BAR -->
    <header id="top-bar">
        <div style="font-weight: 900; font-size: 18px; letter-spacing: -1px;">GHOST DROP <span style="font-size:10px; color:var(--dim)">v2.0</span></div>
        <div style="display:flex; gap:10px; align-items:center;">
            <div id="my-id-display" style="cursor:pointer; font-size:11px; border:1px solid #ccc; padding:4px;">OFFLINE</div>
            <button class="btn btn-icon btn-outline" onclick="app.toggleSettings()">‚öôÔ∏è</button>
        </div>
    </header>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="active">
        <div class="tab-bar">
            <div class="tab-item active" onclick="app.setTab('friends')" id="t-friends">FRIENDS</div>
            <div class="tab-item" onclick="app.setTab('history')" id="t-history">LOGS</div>
        </div>

        <!-- FRIENDS LIST -->
        <div id="pane-friends" style="display:flex; flex-direction:column; height:100%;">
            <div style="padding:12px; border-bottom:2px solid var(--border); background:#fff;">
                <div style="display:flex; gap:8px;">
                    <input id="add-input" class="input" placeholder="Peer ID or Nickname">
                </div>
                <div style="display:flex; gap:8px; margin-top:8px;">
                    <button class="btn btn-outline" style="flex:1" onclick="app.addFriend()">ADD</button>
                    <button class="btn btn-outline" onclick="app.scanQR()">üì∑</button>
                </div>
            </div>
            <div id="friends-list" style="flex:1; overflow-y:auto;"></div>
        </div>

        <!-- HISTORY -->
        <div id="pane-history" style="display:none; flex-direction:column; height:100%;">
            <div style="padding:10px; text-align:right; border-bottom:1px solid #ccc;">
                <button class="btn btn-small btn-outline" onclick="app.clearHistory()">CLEAR</button>
            </div>
            <div id="history-list" style="flex:1; overflow-y:auto;"></div>
        </div>
    </aside>

    <!-- MAIN PANEL -->
    <main id="main-panel">
        <!-- IDLE -->
        <div id="view-idle" class="state-view">
            <h1>READY</h1>
            <p style="color:#666">Select a friend to begin secure transfer.</p>
            <div id="stats-widget" class="stat-grid" style="margin-top:40px;">
                <div><div class="stat-label">TOTAL SENT</div><div id="stat-sent" class="stat-val">0 B</div></div>
                <div><div class="stat-label">TOTAL RECV</div><div id="stat-recv" class="stat-val">0 B</div></div>
            </div>
        </div>

        <!-- CONNECTED -->
        <div id="view-connected" class="state-view hidden">
            <h1 id="c-name">FRIEND</h1>
            <p id="c-id" style="font-size:11px; color:#666; font-family:monospace;">ID</p>
            <div style="margin:20px 0;">
                <div class="signal-bars" id="c-signal" style="justify-content:center; height:20px; gap:4px;">
                    <div class="bar" style="width:6px;"></div><div class="bar" style="width:6px;"></div><div class="bar" style="width:6px;"></div><div class="bar" style="width:6px;"></div>
                </div>
                <div id="c-rtt" style="font-size:10px; margin-top:5px;">RTT: -- ms</div>
            </div>
            
            <input type="file" id="f-input" multiple class="hidden" onchange="transfer.queueFiles(this)">
            <button class="btn" onclick="document.getElementById('f-input').click()" style="padding:20px 40px;">SEND FILES</button>
        </div>

        <!-- TRANSFER -->
        <div id="view-transfer" class="state-view hidden">
            <h2 id="t-status">TRANSFERRING</h2>
            <div id="t-filename" style="font-weight:bold; margin-bottom:10px;">file.ext</div>
            
            <div class="progress-wrap">
                <div id="t-bar" class="progress-fill"></div>
            </div>

            <div class="stat-grid">
                <div><div class="stat-label">SPEED</div><div id="t-speed" class="stat-val">0 KB/s</div></div>
                <div><div class="stat-label">ETA</div><div id="t-eta" class="stat-val">--</div></div>
                <div><div class="stat-label">QUEUE</div><div id="t-queue" class="stat-val">0</div></div>
                <div><div class="stat-label">ERRORS</div><div id="t-err" class="stat-val">0</div></div>
            </div>

            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn btn-outline" id="btn-pause" onclick="transfer.togglePause()">PAUSE</button>
                <button class="btn btn-outline" onclick="transfer.cancel()">CANCEL</button>
            </div>
        </div>

        <!-- INCOMING -->
        <div id="view-incoming" class="state-view hidden">
            <h2>INCOMING FILE</h2>
            <div class="stat-grid">
                <div><div class="stat-label">FROM</div><div id="inc-from" class="stat-val">User</div></div>
                <div><div class="stat-label">SIZE</div><div id="inc-size" class="stat-val">0 MB</div></div>
                <div style="grid-column:1/-1"><div class="stat-label">FILE</div><div id="inc-name" class="stat-val">file</div></div>
            </div>
            <div style="display:flex; gap:20px; justify-content:center;">
                <button class="btn btn-danger" onclick="transfer.respond(false)">REJECT</button>
                <button class="btn" onclick="transfer.respond(true)">ACCEPT</button>
            </div>
            <div style="margin-top:20px;">
                <label><input type="checkbox" id="chk-auto"> Auto-accept future files from this peer</label>
            </div>
        </div>
    </main>

    <!-- MOBILE NAV -->
    <nav class="mobile-nav">
        <button class="nav-btn active" onclick="app.mobNav('friends')" id="mn-friends">FRIENDS</button>
        <button class="nav-btn" onclick="app.mobNav('transfer')" id="mn-transfer">TRANSFER</button>
        <button class="nav-btn" onclick="app.mobNav('history')" id="mn-history">LOGS</button>
    </nav>
</div>

<!-- OVERLAYS -->
<div id="context-menu"></div>

<div id="modal-settings" class="modal-overlay" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-box">
        <h3>SETTINGS</h3>
        <div style="margin:20px 0;">
            <label style="display:block; margin-bottom:10px; font-weight:bold;">Max Speed: <span id="lbl-limit">Unlimited</span></label>
            <input type="range" id="rng-speed" min="0" max="100" value="0" style="width:100%" oninput="app.updateSettings()">
            <div style="font-size:10px; color:#666; display:flex; justify-content:space-between;">
                <span>1 MB/s</span><span>Unlimited</span>
            </div>
        </div>
        <button class="btn btn-outline" style="width:100%" onclick="document.getElementById('modal-settings').style.display='none'">CLOSE</button>
    </div>
</div>

<div id="modal-qr" class="modal-overlay" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-box" style="text-align:center;">
        <h3>IDENTITY</h3>
        <div id="qrcode" style="margin:20px auto; width:128px;"></div>
        <button class="btn" onclick="document.getElementById('modal-qr').style.display='none'">DONE</button>
    </div>
</div>

<div id="modal-scan" class="modal-overlay">
    <div class="modal-box">
        <h3>SCAN CODE</h3>
        <div id="reader" style="width:100%; height:250px; background:#000;"></div>
        <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="app.stopScan()">CANCEL</button>
    </div>
</div>

<div id="modal-nickname" class="modal-overlay">
    <div class="modal-box">
        <h3>EDIT NICKNAME</h3>
        <input id="edit-nick" class="input" style="margin:15px 0;">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-outline" onclick="document.getElementById('modal-nickname').style.display='none'">CANCEL</button>
            <button class="btn" onclick="app.saveNickname()">SAVE</button>
        </div>
    </div>
</div>

<div id="toast-container"></div>

<script>
/**
 * GHOST DROP SOCIAL v2.0
 * Architecture:
 * - Store: LocalStorage wrapper with migrations
 * - Network: PeerJS + Resilience (Backoff, RTT)
 * - Transfer: Chunk pipeline, Queue, Pause/Resume, Verify
 * - UI: Rendering & Event Handling
 */

const CONST = {
    CHUNK_SIZE: 16 * 1024,
    VERIFY_INTERVAL: 64, // Verify every 64 chunks (~1MB)
    MAX_RETRIES: 5
};

// --- STORE & MIGRATION ---
const Store = {
    data: {
        id: null,
        friends: {}, // { id: { nick, added, trusted } }
        history: [],
        stats: { sent: 0, recv: 0 },
        settings: { speedLimit: 0 } // 0 = unlimited (MB/s)
    },
    init() {
        const raw = localStorage.getItem('gd_store');
        if (raw) {
            try {
                const old = JSON.parse(raw);
                // Migration logic could go here
                this.data = { ...this.data, ...old };
            } catch(e) { console.error('Store corrupted', e); }
        } else {
            // Check legacy keys
            this.data.id = localStorage.getItem('gd_id') || 'ghost-' + Math.floor(Math.random()*10000);
            const legFriends = JSON.parse(localStorage.getItem('gd_friends') || '{}');
            Object.keys(legFriends).forEach(k => {
                this.data.friends[k] = { nick: legFriends[k].name || 'Friend', added: Date.now() };
            });
            this.save();
        }
    },
    save() {
        localStorage.setItem('gd_store', JSON.stringify(this.data));
    },
    addHistory(entry) {
        this.data.history.unshift(entry);
        if(this.data.history.length > 50) this.data.history.pop();
        if(entry.status === 'SUCCESS') {
            if(entry.type === 'sent') this.data.stats.sent += entry.size;
            else this.data.stats.recv += entry.size;
        }
        this.save();
        UI.renderHistory();
        UI.renderStats();
    }
};

// --- NETWORK LAYER ---
const Net = {
    peer: null,
    conns: {},
    backoffs: {},
    
    init() {
        this.peer = new Peer(Store.data.id, { debug: 1 });
        this.peer.on('open', id => {
            document.getElementById('my-id-display').innerText = id;
            new QRCode(document.getElementById('qrcode'), { text: id, width: 128, height: 128 });
            this.reconnectAll();
        });
        this.peer.on('connection', conn => this.handleConn(conn));
        this.peer.on('error', err => {
            UI.toast(`Net: ${err.type}`);
            if (err.type === 'peer-unavailable') Transfer.handleError('Peer unavailable');
        });
        this.peer.on('disconnected', () => {
            document.getElementById('my-id-display').innerText = "RECONNECTING...";
            setTimeout(() => this.peer.reconnect(), 2000);
        });
        
        // RTT Pinger
        setInterval(() => this.pingAll(), 2000);
    },

    connect(id) {
        if (this.conns[id] && this.conns[id].open) return;
        const conn = this.peer.connect(id, { reliable: true });
        this.handleConn(conn);
    },

    reconnectAll() {
        Object.keys(Store.data.friends).forEach(id => this.connect(id));
    },

    handleConn(conn) {
        if (this.conns[conn.peer]) this.conns[conn.peer].close();
        this.conns[conn.peer] = conn;
        
        conn.lastPing = Date.now();
        conn.rtt = 0;

        conn.on('open', () => {
            if(conn.dataChannel) conn.dataChannel.bufferedAmountLowThreshold = 65536;
            this.backoffs[conn.peer] = 0;
            UI.updateFriendStatus(conn.peer, true);
        });
        
        conn.on('close', () => {
            UI.updateFriendStatus(conn.peer, false);
            this.retry(conn.peer);
            if (Transfer.active && Transfer.active.peer === conn.peer) {
                Transfer.pause('Connection Lost');
            }
        });

        conn.on('data', data => {
            if (data.constructor === ArrayBuffer || data instanceof Uint8Array) {
                Transfer.receiveChunk(data);
            } else {
                this.handleMsg(conn.peer, data);
            }
        });
    },

    retry(id) {
        const fails = this.backoffs[id] || 0;
        if (fails > 5) return; // Give up temporarily
        const delay = Math.pow(2, fails) * 1000;
        this.backoffs[id] = fails + 1;
        setTimeout(() => this.connect(id), delay);
    },

    pingAll() {
        Object.values(this.conns).forEach(c => {
            if(c.open) {
                c.send({ type: 'PING', ts: Date.now() });
            }
        });
    },

    handleMsg(peer, msg) {
        switch(msg.type) {
            case 'PING': 
                if(this.conns[peer]) this.conns[peer].send({ type: 'PONG', ts: msg.ts });
                break;
            case 'PONG':
                if(this.conns[peer]) {
                    const rtt = Date.now() - msg.ts;
                    this.conns[peer].rtt = rtt;
                    UI.updateSignal(peer, rtt);
                }
                break;
            default: Transfer.router(peer, msg);
        }
    }
};

// --- TRANSFER ENGINE ---
const Transfer = {
    active: null, // { type, peer, file/meta, offset, queue: [], paused, startTs, ... }
    
    queueFiles(input) {
        if(!input.files.length) return;
        const peer = UI.activePeer;
        if(!peer || !Net.conns[peer]?.open) return UI.toast('Peer Offline');

        const queue = Array.from(input.files).map(f => ({ file: f, id: Math.random().toString(36) }));
        input.value = '';

        if (this.active) {
            this.active.queue.push(...queue);
            UI.renderTransfer();
        } else {
            this.startSender(peer, queue);
        }
    },

    startSender(peer, queue) {
        const item = queue.shift();
        if(!item) {
            this.active = null;
            UI.renderMain();
            return;
        }

        this.active = {
            type: 'sender',
            peer,
            file: item.file,
            tid: item.id,
            queue,
            offset: 0,
            paused: false,
            startTs: Date.now(),
            bytesSinceStart: 0,
            checksum: 0
        };

        Net.conns[peer].send({
            type: 'OFFER',
            name: item.file.name,
            size: item.file.size,
            mime: item.file.type,
            tid: item.id
        });

        UI.renderTransfer();
    },

    async senderLoop() {
        const t = this.active;
        if (!t || t.type !== 'sender' || t.paused) return;

        const conn = Net.conns[t.peer];
        if (!conn || !conn.open) return this.pause('Connection Lost');

        // Throttling
        if (Store.data.settings.speedLimit > 0) {
            const limitBytesPerMs = (Store.data.settings.speedLimit * 1024 * 1024) / 1000;
            const elapsed = Date.now() - t.startTs;
            const expected = elapsed * limitBytesPerMs;
            if (t.offset > expected) {
                setTimeout(() => this.senderLoop(), 20);
                return;
            }
        }

        // Backpressure
        if (conn.dataChannel.bufferedAmount > 65536) {
            await new Promise(r => {
                const h = () => { conn.dataChannel.removeEventListener('bufferedamountlow', h); r(); };
                conn.dataChannel.addEventListener('bufferedamountlow', h);
            });
        }

        if (t.offset >= t.file.size) {
            conn.send({ type: 'END', tid: t.tid, checksum: t.checksum });
            return; // Wait for FIN_ACK
        }

        const slice = t.file.slice(t.offset, t.offset + CONST.CHUNK_SIZE);
        const reader = new FileReader();
        reader.onload = e => {
            if (!this.active || this.active.paused) return;
            const buff = e.target.result;
            const arr = new Uint8Array(buff);
            
            // Calc Checksum
            for(let i=0; i<arr.length; i++) t.checksum = (t.checksum + arr[i]) % 65535;

            try {
                conn.send(buff);
                t.offset += buff.byteLength;
                t.bytesSinceStart += buff.byteLength;
                UI.updateProgress();
                this.senderLoop(); // Recursive
            } catch(e) {
                this.handleError('Send Failed');
            }
        };
        reader.readAsArrayBuffer(slice);
    },

    router(peer, msg) {
        switch(msg.type) {
            case 'OFFER':
                if (this.active) return Net.conns[peer].send({ type: 'BUSY', tid: msg.tid });
                // Check Auto-Accept
                const friend = Store.data.friends[peer];
                if (friend && friend.trusted) {
                    this.initReceiver(peer, msg);
                    this.respond(true);
                } else {
                    this.initReceiver(peer, msg); // Shows UI
                }
                break;
            case 'ACCEPT':
                if (this.active?.tid === msg.tid) {
                    this.active.startTs = Date.now(); // Reset stats
                    this.senderLoop();
                }
                break;
            case 'REJECT':
            case 'BUSY':
                UI.toast(`Peer ${msg.type.toLowerCase()}`);
                this.cancel();
                break;
            case 'END':
                this.finalize(msg);
                break;
            case 'FIN_ACK':
                if (this.active?.type === 'sender') {
                    Store.addHistory({ type: 'sent', name: this.active.file.name, size: this.active.file.size, peer: this.active.peer, status: 'SUCCESS', date: Date.now() });
                    // Next file
                    const nextQueue = this.active.queue;
                    const nextPeer = this.active.peer;
                    this.active = null;
                    this.startSender(nextPeer, nextQueue);
                }
                break;
            case 'PAUSE':
                if (this.active) this.active.paused = true;
                UI.renderTransfer();
                UI.toast('Peer paused transfer');
                break;
            case 'RESUME':
                if (this.active) {
                    this.active.paused = false;
                    if (this.active.type === 'sender') this.senderLoop();
                }
                UI.renderTransfer();
                break;
            case 'CANCEL':
                UI.toast('Peer cancelled');
                this.cancel(true);
                break;
        }
    },

    initReceiver(peer, meta) {
        this.active = {
            type: 'receiver', peer, meta, tid: meta.tid,
            received: 0, checksum: 0, chunks: [],
            startTs: Date.now(), bytesSinceStart: 0,
            paused: false, queue: []
        };
        // If not trusted, UI shows accept modal
        if (!Store.data.friends[peer]?.trusted) UI.renderIncoming();
    },

    respond(accept) {
        if (!this.active) return;
        const conn = Net.conns[this.active.peer];
        conn.send({ type: accept ? 'ACCEPT' : 'REJECT', tid: this.active.tid });
        
        if (accept) {
            const auto = document.getElementById('chk-auto')?.checked;
            if(auto) {
                Store.data.friends[this.active.peer].trusted = true;
                Store.save();
            }
            
            // FS API attempt
            if (window.showSaveFilePicker) {
                window.showSaveFilePicker({ suggestedName: this.active.meta.name })
                .then(h => h.createWritable())
                .then(w => { this.active.writable = w; UI.renderTransfer(); })
                .catch(() => { this.active.writable = null; UI.renderTransfer(); });
            } else {
                UI.renderTransfer();
            }
        } else {
            this.active = null;
            UI.renderMain();
        }
    },

    receiveChunk(data) {
        const t = this.active;
        if (!t || t.type !== 'receiver' || t.paused) return;

        const arr = new Uint8Array(data);
        for(let i=0; i<arr.length; i++) t.checksum = (t.checksum + arr[i]) % 65535;
        
        t.received += arr.length;
        t.bytesSinceStart += arr.length;

        if (t.writable) t.writable.write(arr);
        else t.chunks.push(arr);

        UI.updateProgress();
    },

    async finalize(msg) {
        const t = this.active;
        if (!t || t.tid !== msg.tid) return;

        const valid = t.checksum === msg.checksum && t.received === t.meta.size;
        const status = valid ? 'SUCCESS' : 'CORRUPT';

        if (valid) {
            if (t.writable) {
                await t.writable.close();
            } else {
                const blob = new Blob(t.chunks, { type: t.meta.mime });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = t.meta.name; a.click();
                setTimeout(() => URL.revokeObjectURL(url), 1000);
            }
        }

        Store.addHistory({ type: 'recv', name: t.meta.name, size: t.meta.size, peer: t.peer, status, date: Date.now() });
        Net.conns[t.peer].send({ type: 'FIN_ACK', tid: t.tid });
        
        this.active = null;
        UI.toast(`Transfer ${status}`);
        UI.renderMain();
    },

    togglePause() {
        if (!this.active) return;
        this.active.paused = !this.active.paused;
        Net.conns[this.active.peer].send({ type: this.active.paused ? 'PAUSE' : 'RESUME', tid: this.active.tid });
        if (!this.active.paused && this.active.type === 'sender') this.senderLoop();
        UI.renderTransfer();
    },
    
    pause(reason) {
        if(this.active && !this.active.paused) {
            this.active.paused = true;
            UI.toast(reason);
            UI.renderTransfer();
        }
    },

    cancel(silent) {
        if (this.active) {
            if (!silent) Net.conns[this.active.peer].send({ type: 'CANCEL', tid: this.active.tid });
            if (this.active.writable) this.active.writable.abort().catch(()=>{});
        }
        this.active = null;
        UI.renderMain();
    },
    
    handleError(msg) {
        UI.toast(msg);
        this.cancel();
    }
};

// --- UI ---
const UI = {
    activePeer: null,
    longPressTimer: null,

    init() {
        Store.init();
        Net.init();
        this.renderFriends();
        this.renderHistory();
        this.renderStats();
        
        // Settings sliders
        const r = document.getElementById('rng-speed');
        r.value = Store.data.settings.speedLimit;
        this.updateSettings();

        // Global Gestures
        document.body.addEventListener('touchstart', () => { if(navigator.vibrate) navigator.vibrate(5); });
    },

    toast(msg) {
        const t = document.createElement('div');
        t.className = 'toast';
        t.innerHTML = `<span>${msg}</span><span style="cursor:pointer" onclick="this.parentElement.remove()">‚úï</span>`;
        document.getElementById('toast-container').appendChild(t);
        setTimeout(() => t.remove(), 4000);
    },

    // Navigation
    setTab(tab) {
        document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
        document.getElementById('t-'+tab).classList.add('active');
        document.getElementById('pane-friends').style.display = tab === 'friends' ? 'flex' : 'none';
        document.getElementById('pane-history').style.display = tab === 'history' ? 'flex' : 'none';
    },

    mobNav(tab) {
        const sb = document.getElementById('sidebar');
        const mp = document.getElementById('main-panel');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('mn-'+tab).classList.add('active');
        
        if (tab === 'transfer') {
            sb.style.display = 'none'; mp.style.display = 'flex';
        } else {
            sb.style.display = 'flex'; mp.style.display = 'none';
            this.setTab(tab);
        }
    },

    // Friend Management
    renderFriends() {
        const l = document.getElementById('friends-list');
        l.innerHTML = '';
        Object.keys(Store.data.friends).forEach(id => {
            const f = Store.data.friends[id];
            const div = document.createElement('div');
            div.className = `list-item ${this.activePeer === id ? 'active' : ''}`;
            div.innerHTML = `
                <div>
                    <div style="font-weight:bold">${f.nick}</div>
                    <div style="font-size:10px; opacity:0.7">${id}</div>
                </div>
                <div style="text-align:right">
                    <div class="signal-bars" id="sig-${id}">
                        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                    </div>
                </div>
            `;
            
            // Events
            div.onclick = () => this.selectFriend(id);
            div.oncontextmenu = (e) => this.showContext(e, id);
            
            // Long Press
            div.ontouchstart = (e) => { 
                this.longPressTimer = setTimeout(() => this.showContext(e.touches[0], id), 600); 
            };
            div.ontouchend = () => clearTimeout(this.longPressTimer);
            
            l.appendChild(div);
        });
    },

    selectFriend(id) {
        this.activePeer = id;
        this.renderFriends();
        this.renderMain();
        if(window.innerWidth <= 768) this.mobNav('transfer');
    },

    updateSignal(id, rtt) {
        const el = document.getElementById('sig-'+id);
        if(!el) return;
        const bars = el.children;
        const quality = rtt < 100 ? 4 : rtt < 300 ? 3 : rtt < 1000 ? 2 : 1;
        for(let i=0; i<4; i++) {
            bars[i].className = i < quality ? 'bar on' : 'bar';
        }
        if(this.activePeer === id) {
            document.getElementById('c-rtt').innerText = `RTT: ${rtt} ms`;
            const mainSig = document.getElementById('c-signal').children;
            for(let i=0; i<4; i++) mainSig[i].className = i < quality ? 'bar on' : 'bar';
        }
    },

    updateFriendStatus(id, online) {
        if(online) this.toast(`${Store.data.friends[id].nick} Online`);
    },

    addFriend() {
        const inp = document.getElementById('add-input');
        const raw = inp.value.trim();
        if(!raw) return;
        const id = raw.split(' ')[0]; // Basic parse if they pasted full string
        if(id !== Store.data.id) {
            Store.data.friends[id] = { nick: 'Friend', added: Date.now() };
            Store.save();
            this.renderFriends();
            Net.connect(id);
            inp.value = '';
        }
    },

    // Context Menu
    showContext(e, id) {
        e.preventDefault();
        const menu = document.getElementById('context-menu');
        menu.style.display = 'flex';
        menu.style.left = Math.min(e.clientX, window.innerWidth - 160) + 'px';
        menu.style.top = Math.min(e.clientY, window.innerHeight - 200) + 'px';
        
        menu.innerHTML = `
            <div class="ctx-item" onclick="app.editNick('${id}')">Edit Nickname</div>
            <div class="ctx-item" onclick="navigator.clipboard.writeText('${id}'); app.hideContext()">Copy ID</div>
            <div class="ctx-item danger" onclick="app.removeFriend('${id}')">Remove Friend</div>
        `;
        
        const close = () => { menu.style.display = 'none'; document.removeEventListener('click', close); };
        setTimeout(() => document.addEventListener('click', close), 100);
    },
    hideContext() { document.getElementById('context-menu').style.display='none'; },

    editNick(id) {
        document.getElementById('modal-nickname').style.display = 'flex';
        const inp = document.getElementById('edit-nick');
        inp.value = Store.data.friends[id].nick;
        inp.dataset.id = id;
    },
    saveNickname() {
        const inp = document.getElementById('edit-nick');
        const id = inp.dataset.id;
        if(id && inp.value) {
            Store.data.friends[id].nick = inp.value;
            Store.save();
            this.renderFriends();
            if(this.activePeer === id) this.renderMain();
            document.getElementById('modal-nickname').style.display = 'none';
        }
    },
    removeFriend(id) {
        if(confirm('Remove this friend?')) {
            delete Store.data.friends[id];
            Store.save();
            if(Net.conns[id]) Net.conns[id].close();
            if(this.activePeer === id) this.activePeer = null;
            this.renderFriends();
            this.renderMain();
        }
    },

    // Views
    renderMain() {
        if(Transfer.active) return this.renderTransfer();
        document.querySelectorAll('.state-view').forEach(e => e.classList.add('hidden'));
        
        if(!this.activePeer) {
            document.getElementById('view-idle').classList.remove('hidden');
        } else {
            const f = Store.data.friends[this.activePeer];
            if(!f) { this.activePeer = null; return this.renderMain(); }
            
            document.getElementById('view-connected').classList.remove('hidden');
            document.getElementById('c-name').innerText = f.nick;
            document.getElementById('c-id').innerText = this.activePeer;
        }
    },

    renderIncoming() {
        document.querySelectorAll('.state-view').forEach(e => e.classList.add('hidden'));
        document.getElementById('view-incoming').classList.remove('hidden');
        const m = Transfer.active.meta;
        const f = Store.data.friends[Transfer.active.peer];
        document.getElementById('inc-from').innerText = f ? f.nick : 'Unknown';
        document.getElementById('inc-name').innerText = m.name;
        document.getElementById('inc-size').innerText = (m.size/1024/1024).toFixed(1) + ' MB';
    },

    renderTransfer() {
        document.querySelectorAll('.state-view').forEach(e => e.classList.add('hidden'));
        document.getElementById('view-transfer').classList.remove('hidden');
        
        const t = Transfer.active;
        document.getElementById('t-status').innerText = t.paused ? 'PAUSED' : (t.type === 'sender' ? 'SENDING...' : 'RECEIVING...');
        document.getElementById('t-filename').innerText = t.type === 'sender' ? t.file.name : t.meta.name;
        document.getElementById('btn-pause').innerText = t.paused ? 'RESUME' : 'PAUSE';
        document.getElementById('t-queue').innerText = t.queue.length;
        
        this.updateProgress();
    },

    updateProgress() {
        const t = Transfer.active;
        if(!t) return;
        
        const total = t.type === 'sender' ? t.file.size : t.meta.size;
        const pct = (t.offset || t.received) / total * 100;
        document.getElementById('t-bar').style.width = pct + '%';

        // Speed / ETA
        const now = Date.now();
        const diff = (now - t.startTs) / 1000;
        if (diff > 0.5) {
            const speed = t.bytesSinceStart / diff;
            const remaining = total - (t.offset || t.received);
            const eta = speed > 0 ? remaining / speed : 0;
            
            document.getElementById('t-speed').innerText = (speed/1024).toFixed(0) + ' KB/s';
            document.getElementById('t-eta').innerText = eta.toFixed(0) + 's';
        }
    },

    renderHistory() {
        const l = document.getElementById('history-list');
        l.innerHTML = '';
        Store.data.history.forEach(h => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.style.display = 'block';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:11px;">
                    <span>${h.type==='sent'?'‚Üë':'‚Üì'} ${h.name}</span>
                    <span style="color:${h.status==='SUCCESS'?'green':'red'}">${h.status}</span>
                </div>
                <div style="font-size:10px; color:#999; margin-top:4px;">
                    ${(h.size/1024/1024).toFixed(1)} MB ‚Ä¢ ${new Date(h.date).toLocaleTimeString()}
                </div>
            `;
            l.appendChild(div);
        });
    },

    renderStats() {
        document.getElementById('stat-sent').innerText = (Store.data.stats.sent/1024/1024).toFixed(1) + ' MB';
        document.getElementById('stat-recv').innerText = (Store.data.stats.recv/1024/1024).toFixed(1) + ' MB';
    },

    clearHistory() { Store.data.history = []; Store.save(); this.renderHistory(); },

    // Settings
    toggleSettings() { document.getElementById('modal-settings').style.display='flex'; },
    updateSettings() {
        const val = document.getElementById('rng-speed').value;
        Store.data.settings.speedLimit = parseInt(val);
        Store.save();
        document.getElementById('lbl-limit').innerText = val == 0 ? 'Unlimited' : val + ' MB/s';
    },

    // QR
    scanQR() {
        document.getElementById('modal-scan').style.display='flex';
        if(this.scanner) return;
        this.scanner = new Html5Qrcode("reader");
        this.scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
            txt => { this.stopScan(); document.getElementById('add-input').value = txt; this.addFriend(); }
        );
    },
    stopScan() {
        if(this.scanner) this.scanner.stop().then(() => this.scanner.clear());
        this.scanner = null;
        document.getElementById('modal-scan').style.display='none';
    }
};

window.onload = () => UI.init();
</script>
</body>
</html>


